{% extends "base.html" %}
<!-- Включаем наш navbar -->
{% block title %}
Instrument Analysis | {{ symbol }}
{% endblock %}

{% block content %}
{% include "partials/navbar.html" %}
<div class="container mt-4">
  <h1>Analysis for {{ symbol }}</h1>

  <!-- Форма выбора параметров -->
  <form method="get" action="{% url 'instrument_analysis' %}" class="mb-4">
    <div class="row">

      <div class="col-md-4">
        <label for="timeframe">Timeframe:</label>
        <select name="timeframe" id="timeframe" class="form-control">
          <option value="all" {% if timeframe_label == "all" %}selected{% endif %}>All Timeframes</option>
          {% for tf in timeframes %}
          <option value="{{ tf }}" {% if tf == timeframe_label %}selected{% endif %}>{{ tf }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="num_values">Number of Values:</label>
        <input type="number" name="num_values" id="num_values" class="form-control" value="{{ num_values }}">
      </div>
    </div>
    <button type="submit" class="btn btn-primary mt-3">Analyze</button>
  </form>
  <hr>
  {% if error %}
  <p class="text-danger">{{ error }}</p>
  {% else %}
  <div>
    {% for tf_label, data in instrument_data_by_timeframe.items %}
    <h3>Timeframe: {{ tf_label }}</h3>
    <p><strong>Trend:</strong> {{ data.trend }}</p>
    <p><strong>Support:</strong> {{ data.support }}</p>
    <p><strong>Resistance:</strong> {{ data.resistance }}</p>

    <h4>Fibonacci Levels:</h4>
    <ul>
      {% for level, value in data.fib_levels.items %}
      <li>{{ level }}: {{ value }}</li>
      {% endfor %}
    </ul>

    <h4>Liquidity Zones:</h4>
    <p>{{ data.liquidity_zones }}</p>
    {% endfor %}
  </div>
  {% endif %}
</div>
  <hr>

  <!-- Таблица данных -->
  <div class="table-responsive mb-4">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Timeframe</th>
          <th>Trend</th>
          <th>Support</th>
          <th>Resistance</th>
          <th>ATR</th>
        </tr>
      </thead>
      <tbody>
        {% for tf_label, data in instrument_data_by_timeframe.items %}
        <tr>
          <td>{{ tf_label }}</td>
          <td>{{ data.trend }}</td>
          <td>{{ data.support }}</td>
          <td>{{ data.resistance }}</td>
          <td>{{ data.atr }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
<h3>Debug Data (for charts):</h3>
<pre>{{ chart_data }}</pre>
<div id="test-chart" style="width: 100%; height: 500px;"></div>
<!-- Графики -->
<div id="charts">
  {% for chart in chart_data %}
  <h3>{{ chart.timeframe }} Chart</h3>
  <div id="chart-{{ chart.timeframe }}" style="width: 100%; height: 500px;"></div>
  <script>
    (function() {
      const ohlcData = {{ chart.ohlc|safe }};
      const fibLevels = {{ chart.fib_levels|safe }};

      const ohlcTrace = {
      x: ohlcData.time.map(time => new Date(time)), // Преобразуем Timestamp в объект Date
      open: ohlcData.open,
      high: ohlcData.high,
      low: ohlcData.low,
      close: ohlcData.close,
      type: "candlestick",
      name: "OHLC",
    };



      const fibTraces = Object.entries(fibLevels).map(([level, value]) => ({
        x: ohlcData.time.map(time => new Date(time)), // Конвертируем время в формат Date
        y: Array(ohlcData.time.length).fill(value),
        mode: "lines",
        name: `Fib ${level}`,
      }));

      const layout = {
        title: "{{ chart.timeframe }} Chart",
        xaxis: { title: "Time" },
        yaxis: { title: "Price" },
      };

      Plotly.newPlot("chart-{{ chart.timeframe }}", [ohlcTrace, ...fibTraces], layout);
    })();
  </script>
  {% endfor %}
</div>



{% endblock %}
