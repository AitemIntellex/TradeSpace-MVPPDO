{% extends "base.html" %} {% load static %} {% block content %}
<div class="grid-container">
  <!-- Форма фильтрации по датам -->
  <!-- Таблица открытых позиций -->
  {% if open_positions %}

  <div class="card2-custom">
    <h5 class="card-title">Открытые Позиции</h5>
    <table class="trades-table">
      <thead>
        <tr>
          <th>Инструмент</th>
          <th>Объём</th>
          <th>Прибыль</th>
          <th>Тикет</th>
          <th>Направление</th>
        </tr>
      </thead>
      <tbody>
        {% for position in open_positions %}
        <tr>
          <td>{{ position.symbol }}</td>
          <td>{{ position.volume }}</td>
          <td>{{ position.profit }}</td>
          <td>{{ position.ticket }}</td>
          <td>{{ position.order_type }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
  <h5 class="card-title">Нет открытых позиций</h5>
  {% endif %}

  <div class="analysis-buttons">
  <form method="POST" class="inline-form">
    {% csrf_token %}
    <button type="submit" name="analyze_with_ai" class="btn btn-ghost btn-dark">
      Глубокий Анализ
    </button>
  </form>
  <form id="deepAnalysisX3Form" method="POST" class="inline-form">
    {% csrf_token %}
    <button type="button" id="analyzeWithAIx3Button" class="btn btn-secondary">
      Глубокий анализ x3
    </button>
  </form>
</div>

<div class="row">
  <!-- Карточка для глубокого анализа -->
  <div class="col-lg-6 col-md-12 mb-3">
    <div class="rec-container">
      <h3>По Результатам AI Анализа</h3>
      <div id="ai-analysis-text">
        {% if ai_analysis %}
        {{ ai_analysis|safe }}
        {% else %}
        <p>Пока нет данных для отображения.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Карточка для глубокого анализа x3 -->
  <div class="col-lg-6 col-md-12 mb-3">
    <div class="rec-container">
      <h3>По Результатам Глубокого Анализа x3</h3>
      <div id="x3-analysis-text">
        <p>Пока нет данных для отображения.</p>
      </div>
    </div>
  </div>
</div>




    <!-- Установка отложенного ордера -->
    <div class="row">
      <!-- Установка отложенного ордера -->
      <div class="col-md-6">
        <h5 class="section-title">Установка отложенного ордера</h5>
        <form method="POST" id="pendingOrderForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="order_type" class="form-label">Тип ордера:</label>
            <select name="order_type" class="form-control form-custom mr-3" id="order_type">
              <option value="buy_limit">Buy Limit</option>
              <option value="sell_limit">Sell Limit</option>
              <option value="buy_stop">Buy Stop</option>
              <option value="sell_stop">Sell Stop</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="volume_pending" class="form-label">Объем:</label>
            <input
              type="number"
              name="volume"
              class="form-control form-custom"
              id="volume_pending"
              value="0.01"
              step="0.01"
              min="0.01"
            />
          </div>
          <div class="mb-3">
            <label for="price_pending" class="form-label"
              >Цена исполнения:</label
            >
            <input
              type="text"
              name="price"
              class="form-control form-custom"
              id="price_pending"
            />
          </div>
          <div class="mb-3">
            <label for="take_profit_pending" class="form-label"
              >Take Profit:</label
            >
            <input
              type="text"
              name="take_profit"
              class="form-control form-custom"
              id="take_profit_pending"
            />
          </div>
          <div class="mb-3">
            <label for="stop_loss_pending" class="form-label">Stop Loss:</label>
            <input
              type="text"
              name="stop_loss"
              class="form-control form-custom"
              id="stop_loss_pending"
            />
          </div>
          <button
            type="submit"
            name="place_pending_order"
            class="btn btn-primary w-100"
          >
            Установить ордер
          </button>
        </form>

        <!-- Блок расчетов -->
        <div class="mt-4">
          <h5 class="text-light">Расчет:</h5>
          <p class="text-light">
            <strong>Прибыль:</strong> <span id="profit_pending">-</span>
          </p>
          <p class="text-light">
            <strong>Убыток:</strong> <span id="loss_pending">-</span>
          </p>
        </div>
      </div>

      <!-- Открытие рыночной позиции -->
      <div class="col-md-6">
        <h5 class="section-title">Открытие рыночной позиции</h5>
        <form method="POST" id="marketPositionForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="direction" class="form-label">Направление:</label>
            <select name="direction" class="form-control form-custom mr-3" id="direction">
              <option value="buy">Buy</option>
              <option value="sell">Sell</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="volume_market" class="form-label">Объем:</label>
            <input
              type="number"
              name="volume"
              class="form-control form-custom"
              id="volume_market"
              value="0.01"
              step="0.01"
              min="0.01"
            />
          </div>
          <div class="mb-3">
            <label for="take_profit_market" class="form-label"
              >Take Profit:</label
            >
            <input
              type="text"
              name="take_profit"
              class="form-control form-custom"
              id="take_profit_market"
            />
          </div>
          <div class="mb-3">
            <label for="stop_loss_market" class="form-label">Stop Loss:</label>
            <input
              type="text"
              name="stop_loss"
              class="form-control form-custom"
              id="stop_loss_market"
            />
          </div>
          <button
            type="submit"
            name="open_position"
            class="btn btn-primary w-100 btn btn-ghost btn-dark"
          >
            Открыть позицию
          </button>
        </form>

        <!-- Блок расчетов -->
        <div class="mt-4">
          <h5 class="text-light">Расчет:</h5>
          <p class="text-light">
            <strong>Прибыль:</strong> <span id="profit_market">-</span>
          </p>
          <p class="text-light">
            <strong>Убыток:</strong> <span id="loss_market">-</span>
          </p>
        </div>
      </div>
    </div>
    <p class="text-light">
      <strong>Символ:</strong> {{ selected_pair }}<br />
      <strong>Стоимость тика:</strong> ${{ tick_value|floatformat:2 }}
    </p>

    <script>
document.addEventListener("DOMContentLoaded", function () {
  // ======================= ФУНКЦИИ =======================
  /**
   * Функция включения копирования по клику для элементов, найденных по селектору
   */
  function enableCopyOnClick(selector) {
    const elements = document.querySelectorAll(selector);
    elements.forEach((element) => {
      element.addEventListener("click", function () {
        // Если у элемента есть data-value, используем её, иначе textContent
        let valueToCopy = element.getAttribute("data-value") || element.textContent;
        // Меняем запятую на точку (или наоборот — по вашей логике)
        valueToCopy = valueToCopy.trim().replace(",", ".");

        navigator.clipboard
          .writeText(valueToCopy)
          .then(() => {
            // Визуальная обратная связь
            element.style.color = "#28a745";
            element.style.fontWeight = "bold";
            setTimeout(() => {
              element.style.color = "";
              element.style.fontWeight = "";
            }, 1000);
          })
          .catch((err) => {
            console.error("Ошибка копирования: ", err);
          });
      });
    });
  }

  /**
   * Функция включения вставки по клику в поля ввода
   */
  function enablePasteToForms(selector) {
    const inputs = document.querySelectorAll(selector);
    inputs.forEach((input) => {
      input.addEventListener("click", async function () {
        try {
          const clipboardText = await navigator.clipboard.readText();
          if (clipboardText) {
            // Преобразуем точку в запятую (или наоборот) — по вашей логике
            this.value = clipboardText.replace(".", ",");
          }
        } catch (err) {
          console.error("Ошибка при чтении из буфера обмена: ", err);
        }
      });
    });
  }

  /**
   * Функция подсветки слов "Тейк-профит" и "Стоп-лосс" в заданных селекторах
   */
  function formatAnalysisText(selector) {
    const elements = document.querySelectorAll(selector);
    elements.forEach((element) => {
      element.innerHTML = element.innerHTML
        .replace(/Тейк-профит/gi, '<span style="color: yellow; font-weight: bold;">Тейк-профит</span>')
        .replace(/Стоп-лосс/gi, '<span style="color: red; font-weight: bold;">Стоп-лосс</span>');
    });
  }

  /**
   * Функция добавления класса .copyable к числам (примерно как в старом скрипте)
   * Используется, чтобы превращать числа в кликабельные для копирования
   */
  function markNumbersAsCopyable(elementId) {
    const analysisText = document.getElementById(elementId);
    if (analysisText) {
      // Ищем все числа с точкой или без
      const regex = /(\d+\.\d+|\d+)/g;
      let htmlContent = analysisText.innerHTML;

      htmlContent = htmlContent.replace(regex, function (match) {
        return `<span class="copyable" data-value="${match}">${match}</span>`;
      });

      analysisText.innerHTML = htmlContent;
    }
  }

  /**
   * Функция для приведения значений полей (замена запятых на точки) перед отправкой формы
   */
  function convertCommasToDotsInForm(form) {
    // Найдём все inputs внутри формы
    const inputs = form.querySelectorAll("input, textarea");
    inputs.forEach((input) => {
      if (input.value.includes(",")) {
        input.value = input.value.replace(",", ".");
      }
    });
  }

  /**
   * Функция для замены точек на запятые при вводе (примерно как в старом скрипте input-corrected)
   * Можно настроить логику, нужна ли именно эта замена
   */
  function replaceDotWithCommaOnInput(form) {
    const inputs = form.querySelectorAll(".input-corrected");
    inputs.forEach((input) => {
      input.addEventListener("input", function () {
        // Заменяем точки на запятые
        this.value = this.value.replace(/\./g, ",");
      });
    });
  }

  // ======================= 1. Обработка всех форм =======================
  // Выбираем все формы
  const allForms = document.querySelectorAll("form");
  allForms.forEach((form) => {
    // 1) При сабмите заменяем запятые на точки
    form.addEventListener("submit", function (e) {
      convertCommasToDotsInForm(form);
    });

    // 2) Если у нас есть поля, которые нужно корректировать по мере ввода (точки -> запятые)
    //   то дайте этим полям класс .input-corrected
    replaceDotWithCommaOnInput(form);
  });

  // ======================= 2. Копирование и вставка =======================
  // Включаем копирование для элементов с классом .copyable (если они уже есть)
  enableCopyOnClick(".copyable");

  // Включаем вставку для всех инпутов, кроме #volume_pending и #volume_market
  // (пример из вашего кода)
  enablePasteToForms("input.form-control:not(#volume_pending):not(#volume_market)");

  // ======================= 3. Работа с анализом AI и X3 =======================
  // 3.1 Форматируем текст, если уже есть блоки ai-analysis-text и x3-analysis-text
  formatAnalysisText("#ai-analysis-text");
  formatAnalysisText("#x3-analysis-text");

  // 3.2 Добавляем класс .copyable к числам внутри #ai-analysis-text и #x3-analysis-text
  markNumbersAsCopyable("ai-analysis-text");
  markNumbersAsCopyable("x3-analysis-text");

  // Снова привязываем копирование к новым .copyable
  enableCopyOnClick(".copyable");

  // 3.3 Кнопка для глубокого анализа x3
  const x3Button = document.getElementById("analyzeWithAIx3Button");
  const analysisDiv = document.getElementById("x3-analysis-text");
  if (x3Button && analysisDiv) {
    x3Button.addEventListener("click", async function () {
      const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

      // Блокируем кнопку, чтобы показать процесс
      x3Button.disabled = true;
      x3Button.textContent = "Анализ выполняется...";

      try {
        const response = await fetch("{% url 'analyze_with_ai_x3' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({
            symbol: "{{ selected_pair }}", // Пример переменной из Django
          }),
        });

        if (!response.ok) {
          throw new Error("Ошибка запроса: " + response.statusText);
        }

        const data = await response.json();

        // Обновляем результат анализа x3
        analysisDiv.innerHTML = data.analysis || "Результат отсутствует.";

        // Применяем подсветку ключевых слов
        formatAnalysisText("#x3-analysis-text");
        // Делаем числа копируемыми
        markNumbersAsCopyable("x3-analysis-text");
        // Привязываем копирование к новым элементам
        enableCopyOnClick(".copyable");

      } catch (error) {
        console.error("Ошибка выполнения глубокого анализа x3:", error);
        alert("Не удалось выполнить глубокий анализ x3.");
      } finally {
        x3Button.disabled = false;
        x3Button.textContent = "Глубокий анализ x3";
      }
    });
  }

  // ======================= 4. Калькулятор прибыли/убытка =======================
  // 4.1 Значение пункта от брокера
  const pipValueFromBroker = {{ tick_value }};

  // 4.2 Функция расчёта
  function calculateProfitAndLoss(volume, price, takeProfit, stopLoss, profitField, lossField) {
    const pipValue = pipValueFromBroker;

    const vol = parseFloat(volume.replace(",", "."));       // меняем запятую на точку
    const entryPrice = parseFloat(price.replace(",", "."));
    const tp = parseFloat(takeProfit.replace(",", "."));
    const sl = parseFloat(stopLoss.replace(",", "."));

    if (vol && entryPrice && tp && sl) {
      const profit = (tp - entryPrice) * vol * pipValue;
      const loss = (entryPrice - sl) * vol * pipValue;

      document.getElementById(profitField).textContent = profit.toFixed(2);
      document.getElementById(lossField).textContent = loss.toFixed(2);
    } else {
      document.getElementById(profitField).textContent = "-";
      document.getElementById(lossField).textContent = "-";
    }
  }

  // 4.3 Отложенные ордера
  const pendingForm = document.getElementById("pendingOrderForm");
  if (pendingForm) {
    pendingForm.addEventListener("input", () => {
      calculateProfitAndLoss(
        document.getElementById("volume_pending").value,
        document.getElementById("price_pending").value,
        document.getElementById("take_profit_pending").value,
        document.getElementById("stop_loss_pending").value,
        "profit_pending",
        "loss_pending"
      );
    });
  }

  // 4.4 Рыночные позиции
  const marketForm = document.getElementById("marketPositionForm");
  if (marketForm) {
    marketForm.addEventListener("input", () => {
      calculateProfitAndLoss(
        document.getElementById("volume_market").value,
        document.getElementById("price_pending").value,
        document.getElementById("take_profit_market").value,
        document.getElementById("stop_loss_market").value,
        "profit_market",
        "loss_market"
      );
    });
  }
});
</script>


  </div>
  {% endblock %}
</div>
